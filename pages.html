<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Page Creator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px; /* Default margin for editor view */
            background-color: #f4f4f4;
            color: #333;
        }
        #editor-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: monospace;
            font-size: 14px;
        }
        input[type="text"] {
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px; /* Space out buttons */
        }
        button:hover {
            background-color: #0056b3;
        }
        .hidden {
            display: none;
        }

        /* Styles for the full-page viewer mode */
        body.full-page-viewer {
            margin: 0; /* Remove body margin */
            padding: 0; /* Remove body padding */
            background-color: #fff; /* Default background for viewed page */
            overflow: auto; /* Ensure scrolling if content is larger than viewport */
        }
        body.full-page-viewer #editor-container {
            display: none; /* Hide the editor completely */
        }

        /* Styles for the page list */
        #page-list-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #page-list {
            list-style: none;
            padding: 0;
        }
        #page-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        #page-list li:last-child {
            border-bottom: none;
        }
        #page-list li span {
            flex-grow: 1;
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
        }
        #page-list li span:hover {
            color: #0056b3;
        }
        #page-list li button {
            background-color: #dc3545; /* Red for delete */
            margin-left: 10px;
            padding: 5px 8px;
            font-size: 14px;
        }
        #page-list li button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>

    <div id="editor-container">
        <h1>Create Your Page</h1>
        <p>Enter your HTML code below and save it to create your unique page link.</p>
        <label for="page-name-input">Page Name (e.g., index, about, blog/post1):</label>
        <input type="text" id="page-name-input" placeholder="Enter page name (defaults to 'index')">
        <textarea id="html-editor" placeholder="Enter your HTML code here..."></textarea>
        <button id="save-button">Save Page</button>
        <button id="view-page-button">View Current Page</button>
        <p id="share-link-container" class="hidden">
            Your page is available at: <a id="share-link" href="#" target="_blank"></a>
        </p>
    </div>

    <div id="page-list-container">
        <h2>Your Pages</h2>
        <ul id="page-list">
            <p id="no-pages-message">No pages found. Start by creating one above!</p>
        </ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAFsLLNDebmJ5qiJB-HP9gqdQmgXI0KcQU",
            authDomain: "noteshare-c6815.firebaseapp.com",
            projectId: "noteshare-c6815",
            storageBucket: "noteshare-c6815.firebasestorage.app",
            messagingSenderId: "193971626161",
            appId: "1:193971626161:web:f5361df1fb0d2cc08a4290",
            measurementId: "G-5YWVLKRVRT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // db instance is directly available after init
        const auth = getAuth(app);

        const htmlEditor = document.getElementById('html-editor');
        const pageNameInput = document.getElementById('page-name-input');
        const saveButton = document.getElementById('save-button');
        const viewPageButton = document.getElementById('view-page-button');
        const shareLinkContainer = document.getElementById('share-link-container');
        const shareLink = document.getElementById('share-link');
        const editorContainer = document.getElementById('editor-container');
        const pageListContainer = document.getElementById('page-list-container');
        const pageList = document.getElementById('page-list');
        const noPagesMessage = document.getElementById('no-pages-message');
        const body = document.body;

        let currentUserId = null;

        /**
         * Loads HTML content for a specific page of the current user into the editor.
         * Defaults to 'index' if no page name is provided.
         * @param {string} userId - The UID of the authenticated user.
         * @param {string} [pageName='index'] - The name of the page to load.
         */
        async function loadHtmlIntoEditor(userId, pageName = 'index') {
            if (!db) {
                console.warn("Firestore (db) not initialized when attempting to load HTML.");
                return;
            }
            try {
                const docRef = doc(db, "pages", userId, "userPages", pageName);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    htmlEditor.value = data.html;
                    pageNameInput.value = pageName;
                    console.log(`Loaded HTML for page '${pageName}' into editor.`);
                } else {
                    console.log(`No saved HTML found for user '${userId}' and page '${pageName}'.`);
                    htmlEditor.value = "";
                    if (pageName === 'index') {
                        pageNameInput.value = "";
                    } else {
                        pageNameInput.value = pageName;
                    }
                }
                if (currentUserId) {
                    displayUserPages(currentUserId);
                }
            } catch (e) {
                console.error("Error loading HTML into editor:", e);
                htmlEditor.value = "";
                pageNameInput.value = "";
            }
        }

        /**
         * Fetches and displays all pages for the current user.
         * @param {string} userId - The UID of the authenticated user.
         */
        async function displayUserPages(userId) {
            if (!userId) {
                pageList.innerHTML = '<p>Please log in to see your pages.</p>';
                return;
            }
            if (!db) {
                console.warn("Firestore (db) not initialized when attempting to display user pages.");
                pageList.innerHTML = '<p>Error: Database not ready.</p>';
                return;
            }

            try {
                const pagesRef = collection(db, "pages", userId, "userPages");
                const querySnapshot = await getDocs(pagesRef);

                pageList.innerHTML = ''; // Clear existing list
                if (querySnapshot.empty) {
                    noPagesMessage.classList.remove('hidden');
                    pageList.appendChild(noPagesMessage);
                } else {
                    noPagesMessage.classList.add('hidden');
                    querySnapshot.forEach((docSnap) => { // Renamed 'doc' to 'docSnap' to avoid conflict with Firestore's doc() function
                        const pageName = docSnap.id; // Use docSnap.id to get the document ID (page name)
                        const listItem = document.createElement('li');

                        const pageNameSpan = document.createElement('span');
                        pageNameSpan.textContent = pageName;
                        pageNameSpan.style.cursor = 'pointer';
                        pageNameSpan.onclick = () => {
                            loadHtmlIntoEditor(currentUserId, pageName);
                        };

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.onclick = async (event) => {
                            event.stopPropagation();
                            if (!currentUserId || !db) { // Additional check before attempting delete
                                console.error("Cannot delete: currentUserId or db is not available.");
                                alert("Cannot delete page: Authentication or database connection not ready.");
                                return;
                            }
                            if (confirm(`Are you sure you want to delete the page "${pageName}"? This action cannot be undone.`)) {
                                try {
                                    // ADDED DEBUGGING LOGS HERE
                                    console.log("Attempting to delete page:");
                                    console.log("  db instance (should not be null/undefined):", db);
                                    console.log("  currentUserId (should not be null/undefined):", currentUserId);
                                    console.log("  pageName (to delete):", pageName);

                                    const docRefToDelete = doc(db, "pages", currentUserId, "userPages", pageName);
                                    console.log("  Generated Document Reference:", docRefToDelete); // Check if this is a valid object

                                    await deleteDoc(docRefToDelete);
                                    alert(`Page "${pageName}" deleted successfully!`);
                                    if (pageNameInput.value === pageName) {
                                        htmlEditor.value = '';
                                        pageNameInput.value = '';
                                    }
                                    displayUserPages(currentUserId);
                                } catch (e) {
                                    console.error("Error deleting page:", e);
                                    console.error("Full error object for delete:", e); // Get full error details
                                    alert(`Error deleting page "${pageName}". Please check the console for details.`);
                                }
                            }
                        };

                        listItem.appendChild(pageNameSpan);
                        listItem.appendChild(deleteButton);
                        pageList.appendChild(listItem);
                    });
                }
            } catch (e) {
                console.error("Error fetching user pages:", e);
                pageList.innerHTML = '<p>Error loading your pages.</p>';
            }
        }

        // Authenticate anonymously
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("Authenticated as:", currentUserId);
                checkUrlHashAndLoadPage();
                displayUserPages(currentUserId);
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error("Error signing in anonymously:", error);
                    pageList.innerHTML = '<p>Please enable third-party cookies or sign in to manage your pages.</p>';
                    // Ensure editor is hidden and user knows they can't edit without auth
                    editorContainer.classList.add('hidden');
                });
            }
        });

        // Event listener for the Save Page button
        saveButton.addEventListener('click', async () => {
            if (!currentUserId || !db) { // Added db check
                alert("Please wait for authentication and database connection to complete.");
                return;
            }
            const htmlContent = htmlEditor.value;
            const pageName = pageNameInput.value.trim().toLowerCase().replace(/\s+/g, '-') || 'index';

            if (!pageName.match(/^[a-z0-9_.-]+(\/[a-z0-9_.-]+)*$/)) {
                alert("Page name can only contain lowercase letters, numbers, underscores, hyphens, and periods (e.g., 'index.html', 'my-page', 'blog/post-1').");
                return;
            }

            try {
                const docRef = doc(db, "pages", currentUserId, "userPages", pageName);
                await setDoc(docRef, {
                    html: htmlContent,
                    timestamp: new Date()
                });
                alert(`Page '${pageName}' saved successfully!`);

                const pageUrl = `${window.location.origin}${window.location.pathname}#${currentUserId}/${pageName}`;
                shareLink.href = pageUrl;
                shareLink.textContent = pageUrl;
                shareLinkContainer.classList.remove('hidden');

                displayUserPages(currentUserId);
            } catch (e) {
                console.error("Error saving document: ", e);
                alert("Error saving page. Please try again.");
            }
        });

        // Event listener for the View Current Page button
        viewPageButton.addEventListener('click', () => {
            if (!currentUserId) {
                alert("Please wait for authentication to complete.");
                return;
            }
            const pageName = pageNameInput.value.trim().toLowerCase().replace(/\s+/g, '-') || 'index';

            if (!pageName.match(/^[a-z0-9_.-]+(\/[a-z0-9_.-]+)*$/)) {
                alert("Page name can only contain lowercase letters, numbers, underscores, hyphens, and periods.");
                return;
            }

            const pageUrl = `${window.location.origin}${window.location.pathname}#${currentUserId}/${pageName}`;
            window.open(pageUrl, '_blank');
        });

        /**
         * Loads and displays the HTML content for a given user ID and page name.
         * @param {string} userId - The UID of the user whose page is to be loaded.
         * @param {string} pageName - The name of the page to load.
         */
        async function loadPage(userId, pageName) {
            if (!db) {
                console.warn("Firestore (db) not initialized when attempting to load page for viewing.");
                body.innerHTML = "<p style='text-align: center; margin-top: 50px;'>Error: Database not ready.</p>";
                body.classList.add('full-page-viewer');
                return;
            }
            try {
                const docRef = doc(db, "pages", userId, "userPages", pageName);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    body.innerHTML = data.html;
                    body.classList.add('full-page-viewer');
                } else {
                    body.innerHTML = `<p style='text-align: center; margin-top: 50px;'>No page found for user ID '${userId}' and page name '${pageName}'.</p>`;
                    body.classList.add('full-page-viewer');
                }
            } catch (e) {
                console.error("Error getting document:", e);
                body.innerHTML = "<p style='text-align: center; margin-top: 50px;'>Error loading page.</p>";
                body.classList.add('full-page-viewer');
            }
        }

        /**
         * Checks the URL hash for user ID and page name, then loads the page or shows the editor.
         */
        function checkUrlHashAndLoadPage() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const hashParts = hash.split('/');
                const userIdFromHash = hashParts[0];
                const pageNameFromHash = hashParts[1] || 'index';

                if (userIdFromHash) {
                    editorContainer.classList.add('hidden');
                    pageListContainer.classList.add('hidden');
                    loadPage(userIdFromHash, pageNameFromHash);
                } else {
                    editorContainer.classList.remove('hidden');
                    pageListContainer.classList.remove('hidden');
                    if (currentUserId) {
                        loadHtmlIntoEditor(currentUserId);
                    }
                }
            } else {
                editorContainer.classList.remove('hidden');
                pageListContainer.classList.remove('hidden');
                if (currentUserId) {
                    loadHtmlIntoEditor(currentUserId);
                }
            }
        }

        window.addEventListener('hashchange', checkUrlHashAndLoadPage);
    </script>
</body>
</html>
