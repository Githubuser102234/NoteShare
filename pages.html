<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Page Creator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px; /* Default margin for editor view */
            background-color: #f4f4f4;
            color: #333;
        }
        #editor-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: monospace;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .hidden {
            display: none;
        }

        /* Styles for the full-page viewer mode */
        body.full-page-viewer {
            margin: 0; /* Remove body margin */
            padding: 0; /* Remove body padding */
            background-color: #fff; /* Default background for viewed page */
            overflow: auto; /* Ensure scrolling if content is larger than viewport */
        }
        body.full-page-viewer #editor-container {
            display: none; /* Hide the editor completely */
        }
    </style>
</head>
<body>

    <div id="editor-container">
        <h1>Create Your Page</h1>
        <p>Enter your HTML code below and save it to create your unique page link.</p>
        <textarea id="html-editor" placeholder="Enter your HTML code here..."></textarea>
        <button id="save-button">Save Page</button>
        <p id="share-link-container" class="hidden">
            Your page is available at: <a id="share-link" href="#" target="_blank"></a>
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAFsLLNDebmJ5qiJB-HP9gqdQmgXI0KcQU",
            authDomain: "noteshare-c6815.firebaseapp.com",
            projectId: "noteshare-c6815",
            storageBucket: "noteshare-c6815.firebasestorage.app",
            messagingSenderId: "193971626161",
            appId: "1:193971626161:web:f5361df1fb0d2cc08a4290",
            measurementId: "G-5YWVLKRVRT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const htmlEditor = document.getElementById('html-editor');
        const saveButton = document.getElementById('save-button');
        const shareLinkContainer = document.getElementById('share-link-container');
        const shareLink = document.getElementById('share-link');
        const editorContainer = document.getElementById('editor-container');
        const body = document.body; // Reference to the body element

        let currentUserId = null;

        // Function to load HTML into the editor
        async function loadHtmlIntoEditor(userId) {
            try {
                const docRef = doc(db, "pages", userId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    htmlEditor.value = data.html; // Set the textarea value
                    console.log("Loaded HTML into editor.");
                } else {
                    console.log("No saved HTML found for this user.");
                    htmlEditor.value = ""; // Clear editor if no content
                }
            } catch (e) {
                console.error("Error loading HTML into editor:", e);
                htmlEditor.value = ""; // Clear editor on error
            }
        }

        // Authenticate anonymously
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("Authenticated as:", currentUserId);
                // After authentication, check if we need to load a page or show the editor
                // If in editor mode (no hash), load the user's saved content
                if (!window.location.hash) {
                    loadHtmlIntoEditor(currentUserId);
                }
                checkUrlHashAndLoadPage();
            } else {
                // Not signed in, sign in anonymously
                signInAnonymously(auth).catch((error) => {
                    console.error("Error signing in anonymously:", error);
                });
            }
        });

        // Function to save HTML
        saveButton.addEventListener('click', async () => {
            if (!currentUserId) {
                alert("Please wait for authentication to complete.");
                return;
            }
            const htmlContent = htmlEditor.value;
            const userId = currentUserId; // Use the authenticated user's UID

            try {
                await setDoc(doc(db, "pages", userId), {
                    html: htmlContent,
                    timestamp: new Date()
                });
                alert("Page saved successfully!");
                const pageUrl = window.location.origin + window.location.pathname + "#" + userId;
                shareLink.href = pageUrl;
                shareLink.textContent = pageUrl;
                shareLinkContainer.classList.remove('hidden');
            } catch (e) {
                console.error("Error saving document: ", e);
                alert("Error saving page. Please try again.");
            }
        });

        // Function to load HTML for viewing a page
        async function loadPage(userId) {
            try {
                const docRef = doc(db, "pages", userId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Inject user's HTML directly into the body
                    body.innerHTML = data.html;
                    body.classList.add('full-page-viewer'); // Add class to body for full page styling
                } else {
                    // If no page found, show a simple message
                    body.innerHTML = "<p style='text-align: center; margin-top: 50px;'>No page found for this ID.</p>";
                    body.classList.add('full-page-viewer'); // Maintain full page viewer style
                }
            } catch (e) {
                console.error("Error getting document:", e);
                body.innerHTML = "<p style='text-align: center; margin-top: 50px;'>Error loading page.</p>";
                body.classList.add('full-page-viewer');
            }
        }

        // Check URL hash for user ID and load page or show editor
        function checkUrlHashAndLoadPage() {
            const hash = window.location.hash.substring(1); // Get hash without '#'
            if (hash) {
                // If a hash exists, hide the editor and load the page for viewing
                editorContainer.classList.add('hidden');
                loadPage(hash);
            } else {
                // If no hash, show the editor and load previously saved HTML
                editorContainer.classList.remove('hidden');
                body.classList.remove('full-page-viewer'); // Remove full page viewer style
                if (currentUserId) { // Only attempt to load if authenticated
                    loadHtmlIntoEditor(currentUserId);
                }
            }
        }

        // Listen for hash changes (e.g., if user types a new hash in the URL bar)
        window.addEventListener('hashchange', checkUrlHashAndLoadPage);

        // Initial check is handled by onAuthStateChanged, which ensures currentUserId is set before checking the hash.
    </script>
</body>
</html>
