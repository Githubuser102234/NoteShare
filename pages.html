<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Page Creator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px; /* Default margin for editor view */
            background-color: #f4f4f4;
            color: #333;
        }
        #editor-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: monospace;
            font-size: 14px;
        }
        input[type="text"] {
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px; /* Space out buttons */
        }
        button:hover {
            background-color: #0056b3;
        }
        .hidden {
            display: none;
        }

        /* Styles for the full-page viewer mode */
        body.full-page-viewer {
            margin: 0; /* Remove body margin */
            padding: 0; /* Remove body padding */
            background-color: #fff; /* Default background for viewed page */
            overflow: auto; /* Ensure scrolling if content is larger than viewport */
        }
        body.full-page-viewer #editor-container {
            display: none; /* Hide the editor completely */
        }
    </style>
</head>
<body>

    <div id="editor-container">
        <h1>Create Your Page</h1>
        <p>Enter your HTML code below and save it to create your unique page link.</p>
        <label for="page-name-input">Page Name (e.g., index, about, blog/post1):</label>
        <input type="text" id="page-name-input" placeholder="Enter page name (defaults to 'index')">
        <textarea id="html-editor" placeholder="Enter your HTML code here..."></textarea>
        <button id="save-button">Save Page</button>
        <button id="view-page-button">View Current Page</button>
        <p id="share-link-container" class="hidden">
            Your page is available at: <a id="share-link" href="#" target="_blank"></a>
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAFsLLNDebmJ5qiJB-HP9gqdQmgXI0KcQU",
            authDomain: "noteshare-c6815.firebaseapp.com",
            projectId: "noteshare-c6815",
            storageBucket: "noteshare-c6815.firebasestorage.app",
            messagingSenderId: "193971626161",
            appId: "1:193971626161:web:f5361df1fb0d2cc08a4290",
            measurementId: "G-5YWVLKRVRT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const htmlEditor = document.getElementById('html-editor');
        const pageNameInput = document.getElementById('page-name-input');
        const saveButton = document.getElementById('save-button');
        const viewPageButton = document.getElementById('view-page-button');
        const shareLinkContainer = document.getElementById('share-link-container');
        const shareLink = document.getElementById('share-link');
        const editorContainer = document.getElementById('editor-container');
        const body = document.body; // Reference to the body element

        let currentUserId = null;

        /**
         * Loads HTML content for a specific page of the current user into the editor.
         * Defaults to 'index' if no page name is provided.
         * @param {string} userId - The UID of the authenticated user.
         * @param {string} [pageName='index'] - The name of the page to load.
         */
        async function loadHtmlIntoEditor(userId, pageName = 'index') {
            try {
                // Construct the document reference to the specific page within the user's subcollection
                const docRef = doc(db, "pages", userId, "userPages", pageName);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    htmlEditor.value = data.html; // Set the textarea value
                    pageNameInput.value = pageName; // Set the page name input field
                    console.log(`Loaded HTML for page '${pageName}' into editor.`);
                } else {
                    console.log(`No saved HTML found for user '${userId}' and page '${pageName}'.`);
                    htmlEditor.value = ""; // Clear editor if no content
                    // Only clear page name input if it's the default 'index' being loaded
                    if (pageName === 'index') {
                        pageNameInput.value = "";
                    } else {
                        pageNameInput.value = pageName;
                    }
                }
            } catch (e) {
                console.error("Error loading HTML into editor:", e);
                htmlEditor.value = ""; // Clear editor on error
                pageNameInput.value = ""; // Clear page name input on error
            }
        }

        // Authenticate anonymously
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("Authenticated as:", currentUserId);
                // After authentication, check if we need to load a page or show the editor
                checkUrlHashAndLoadPage();
            } else {
                // Not signed in, sign in anonymously
                signInAnonymously(auth).catch((error) => {
                    console.error("Error signing in anonymously:", error);
                });
            }
        });

        // Event listener for the Save Page button
        saveButton.addEventListener('click', async () => {
            if (!currentUserId) {
                alert("Please wait for authentication to complete.");
                return;
            }
            const htmlContent = htmlEditor.value;
            // Get the page name from the input, default to 'index' if empty
            // Sanitize the page name: convert to lowercase and replace spaces with hyphens
            const pageName = pageNameInput.value.trim().toLowerCase().replace(/\s+/g, '-') || 'index';

            // Basic validation for page name
            if (!pageName.match(/^[a-z0-9_.-]+(\/[a-z0-9_.-]+)*$/)) {
                alert("Page name can only contain lowercase letters, numbers, underscores, hyphens, and periods (e.g., 'index.html', 'my-page', 'blog/post-1').");
                return;
            }

            try {
                // Define the document reference for the specific page within the user's subcollection
                const docRef = doc(db, "pages", currentUserId, "userPages", pageName);
                await setDoc(docRef, {
                    html: htmlContent,
                    timestamp: new Date()
                });
                alert(`Page '${pageName}' saved successfully!`);

                // Construct the shareable URL
                const pageUrl = `${window.location.origin}${window.location.pathname}#${currentUserId}/${pageName}`;
                shareLink.href = pageUrl;
                shareLink.textContent = pageUrl;
                shareLinkContainer.classList.remove('hidden');
            } catch (e) {
                console.error("Error saving document: ", e);
                alert("Error saving page. Please try again.");
            }
        });

        // Event listener for the View Current Page button
        viewPageButton.addEventListener('click', () => {
            if (!currentUserId) {
                alert("Please wait for authentication to complete.");
                return;
            }
            const pageName = pageNameInput.value.trim().toLowerCase().replace(/\s+/g, '-') || 'index';

            if (!pageName.match(/^[a-z0-9_.-]+(\/[a-z0-9_.-]+)*$/)) {
                alert("Page name can only contain lowercase letters, numbers, underscores, hyphens, and periods.");
                return;
            }

            const pageUrl = `${window.location.origin}${window.location.pathname}#${currentUserId}/${pageName}`;
            window.open(pageUrl, '_blank'); // Open in a new tab
        });

        /**
         * Loads and displays the HTML content for a given user ID and page name.
         * @param {string} userId - The UID of the user whose page is to be loaded.
         * @param {string} pageName - The name of the page to load.
         */
        async function loadPage(userId, pageName) {
            try {
                // Construct the document reference to the specific page within the user's subcollection
                const docRef = doc(db, "pages", userId, "userPages", pageName);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Inject user's HTML directly into the body
                    body.innerHTML = data.html;
                    body.classList.add('full-page-viewer'); // Add class to body for full page styling
                } else {
                    // If no page found, show a simple message
                    body.innerHTML = `<p style='text-align: center; margin-top: 50px;'>No page found for user ID '${userId}' and page name '${pageName}'.</p>`;
                    body.classList.add('full-page-viewer'); // Maintain full page viewer style
                }
            } catch (e) {
                console.error("Error getting document:", e);
                body.innerHTML = "<p style='text-align: center; margin-top: 50px;'>Error loading page.</p>";
                body.classList.add('full-page-viewer');
            }
        }

        /**
         * Checks the URL hash for user ID and page name, then loads the page or shows the editor.
         */
        function checkUrlHashAndLoadPage() {
            const hash = window.location.hash.substring(1); // Get hash without '#'
            if (hash) {
                // Split the hash into userId and potential pageName (e.g., "user123/index.html")
                const hashParts = hash.split('/');
                const userIdFromHash = hashParts[0];
                // Default to 'index' if no page name is specified in the hash
                const pageNameFromHash = hashParts[1] || 'index';

                if (userIdFromHash) {
                    // If a user ID is found in the hash, hide the editor and load the specified page
                    editorContainer.classList.add('hidden');
                    loadPage(userIdFromHash, pageNameFromHash);
                } else {
                    // If hash is present but malformed, show editor
                    editorContainer.classList.remove('hidden');
                    body.classList.remove('full-page-viewer'); // Remove full page viewer style
                    if (currentUserId) { // Only attempt to load if authenticated
                        loadHtmlIntoEditor(currentUserId);
                    }
                }
            } else {
                // If no hash, show the editor and load the current user's default 'index' page
                editorContainer.classList.remove('hidden');
                body.classList.remove('full-page-viewer'); // Remove full page viewer style
                if (currentUserId) { // Only attempt to load if authenticated
                    loadHtmlIntoEditor(currentUserId); // Load default 'index' page
                }
            }
        }

        // Listen for hash changes (e.g., if user types a new hash in the URL bar)
        window.addEventListener('hashchange', checkUrlHashAndLoadPage);

        // Initial check is handled by onAuthStateChanged, which ensures currentUserId is set before checking the hash.
    </script>
</body>
</html>
